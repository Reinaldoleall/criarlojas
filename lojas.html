<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal de Lojas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-secondary: #625B71;
            --md-sys-color-background: #F8F9FA;
            --md-sys-color-surface: #FFFFFF;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #CAC4D0;
            --md-sys-font-family: 'Inter', sans-serif;
            --md-sys-border-radius: 16px;
            --md-sys-elevation-1: 0 2px 4px rgba(0,0,0,0.05);
            --md-sys-elevation-2: 0 4px 12px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--md-sys-font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-surface);
            -webkit-font-smoothing: antialiased;
        }
        
        /* --- HEADER FIXO E PROFISSIONAL --- */
        .page-header {
            background-color: var(--md-sys-color-surface);
            padding: 16px;
            border-bottom: 1px solid #E0E0E0;
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
            text-align: left;
            margin-bottom: 16px;
        }
        .controls-wrapper {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .search-container {
            position: relative;
            flex-grow: 1;
        }
        .search-input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            font-size: 1rem;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 28px;
            background-color: var(--md-sys-color-background);
            transition: all 0.2s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 3px var(--md-sys-color-primary-container);
        }
        .search-container .material-icons-outlined {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
        }
        .sort-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: none;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .sort-button:hover {
            background-color: #f0f0f0;
            border-color: var(--md-sys-color-primary);
        }
        .sort-button .material-icons-outlined {
            font-size: 24px;
            color: var(--md-sys-color-on-surface-variant);
            transition: transform 0.3s ease;
        }

        /* --- CONTEÚDO PRINCIPAL --- */
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 16px;
        }
        
        /* --- GRID DE RESULTADOS --- */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }
        .store-card, .product-card {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-border-radius);
            box-shadow: var(--md-sys-elevation-1);
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
            border: 1px solid #E0E0E0;
        }
        .store-card:hover, .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--md-sys-elevation-2);
        }
        .card-banner {
            height: 0;
            padding-top: 56.25%; /* Proporção 16:9 */
            background-size: cover;
            background-position: center;
            background-color: #f0f0f0;
        }
        .card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .store-card__title, .product-card__title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .store-card__description {
            font-size: 0.95rem;
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.5;
            flex-grow: 1;
            margin-bottom: 16px;
        }
        .product-card__store-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--md-sys-color-secondary);
            margin-bottom: 4px;
        }
        .product-card__price {
            font-size: 1.2rem;
            color: var(--md-sys-color-primary);
            font-weight: 700;
            margin-top: auto; /* Alinha o preço na base */
        }
        .store-card__button {
            margin-top: auto; /* Alinha o botão na base */
            color: var(--md-sys-color-primary);
            font-weight: 700;
            text-decoration: none;
            align-self: flex-end;
        }

        /* --- SKELETON LOADER --- */
        .skeleton-card {
             background-color: var(--md-sys-color-surface);
             border-radius: var(--md-sys-border-radius);
             overflow: hidden;
             border: 1px solid #E0E0E0;
        }
        .skeleton-banner {
            padding-top: 56.25%;
            background: #f0f0f0;
        }
        .skeleton-content { padding: 20px; }
        .skeleton-line {
            height: 16px;
            border-radius: 8px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-shine 1.5s linear infinite;
        }
        .skeleton-line.title { height: 22px; width: 70%; margin-bottom: 12px; }
        .skeleton-line.text { width: 100%; margin-bottom: 8px; }
        .skeleton-line.text-short { width: 85%; }
        @keyframes skeleton-shine {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* --- ESTADO VAZIO --- */
        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: var(--md-sys-color-on-surface-variant);
            grid-column: 1 / -1;
        }
        .empty-state .material-icons-outlined { font-size: 4rem; margin-bottom: 16px; }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .page-container { padding: 24px 16px; }
            .results-grid { gap: 16px; }
        }
        @media (max-width: 480px) {
             .results-grid {
                grid-template-columns: 1fr; /* Uma coluna em telas muito pequenas */
            }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <div class="header-content">
            <h1 id="pageTitle">Explorar Lojas</h1>
            <div class="controls-wrapper">
                <div class="search-container">
                    <i class="material-icons-outlined">search</i>
                    <input type="search" id="searchInput" class="search-input" placeholder="Buscar por loja ou produto...">
                </div>
                <button class="sort-button" id="sortButton" aria-label="Ordenar resultados">
                    <i class="material-icons-outlined">arrow_downward</i>
                </button>
            </div>
        </div>
    </header>

    <main class="page-container">
        <div class="results-grid" id="resultsGrid">
            <!-- A loja fixa será adicionada aqui via JavaScript -->
        </div>
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="material-icons-outlined">search_off</i>
            <h2>Nenhum resultado encontrado</h2>
            <p>Tente ajustar sua busca ou explore todas as nossas lojas.</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyD8FxHqt1g2V-mmureRPQyYe6QCuRSieGI",
                authDomain: "marketplaceconnect-af26d.firebaseapp.com",
                databaseURL: "https://marketplaceconnect-af26d-default-rtdb.firebaseio.com",
                projectId: "marketplaceconnect-af26d",
                storageBucket: "marketplaceconnect-af26d.firebasestorage.app",
                messagingSenderId: "768552546759",
                appId: "1:768552546759:web:4367fc4a161ecf90c469e2",
                measurementId: "G-7HHR78MHDP"
            };
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);

            const resultsGrid = document.getElementById('resultsGrid');
            const searchInput = document.getElementById('searchInput');
            const sortButton = document.getElementById('sortButton');
            const emptyState = document.getElementById('emptyState');
            
            let allStores = [];
            let sortOrder = 'asc'; // 'asc' para A-Z

            // Loja fixa - Magazine Luiza
            const fixedStore = {
                id: 'magazine-luiza',
                name: 'Magazine Luiza',
                description: 'Tudo que você precisa em um só lugar! Eletrônicos, móveis, eletrodomésticos e muito mais.',
                logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_FSBujTblqbK8XqF25lLhiwbVnse-eEm3V_YiSxE3hQ&s=10',
                type: 'store',
                isFixed: true
            };

            const debounce = (func, delay) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            };

            const showSkeletons = (count = 6) => {
                resultsGrid.innerHTML = '';
                emptyState.style.display = 'none';
                const fragment = document.createDocumentFragment();
                for (let i = 0; i < count; i++) {
                    const card = document.createElement('div');
                    card.className = 'skeleton-card';
                    card.innerHTML = `
                        <div class="skeleton-banner"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-line title"></div>
                            <div class="skeleton-line text"></div>
                            <div class="skeleton-line text-short"></div>
                        </div>
                    `;
                    fragment.appendChild(card);
                }
                resultsGrid.appendChild(fragment);
            };

            async function fetchStores() {
                try {
                    const storesRef = ref(db, 'stores/');
                    const snapshot = await get(storesRef);
                    if (snapshot.exists()) {
                        const storesData = snapshot.val();
                        allStores = Object.entries(storesData).map(([id, store]) => ({
                            id,
                            ...store,
                            products: store.products ? Object.values(store.products) : []
                        }));
                        sortAndFilter();
                    } else {
                        showEmptyState(true, 'Nenhuma loja encontrada.');
                    }
                } catch (error) {
                    console.error("Erro ao buscar lojas:", error);
                    showEmptyState(true, 'Ocorreu um erro ao carregar as lojas.');
                }
            }

            function renderResults(itemsToRender) {
                resultsGrid.innerHTML = '';
                if (itemsToRender.length === 0) {
                    showEmptyState(true);
                    return;
                }
                
                showEmptyState(false);
                const fragment = document.createDocumentFragment();
                
                // Adiciona a loja fixa primeiro
                const fixedStoreCard = document.createElement('a');
                fixedStoreCard.href = 'https://www.magazinevoce.com.br/magazinereinaldoleal/';
                fixedStoreCard.target = "_blank";
                fixedStoreCard.className = 'store-card';
                fixedStoreCard.innerHTML = `
                    <div class="card-banner" style="background-image: url('${fixedStore.logo}')"></div>
                    <div class="card-content">
                        <h3 class="store-card__title">${fixedStore.name}</h3>
                        <p class="store-card__description">${fixedStore.description}</p>
                        <span class="store-card__button">Visitar Loja →</span>
                    </div>
                `;
                fragment.appendChild(fixedStoreCard);
                
                // Adiciona as outras lojas
                itemsToRender.forEach(item => {
                    const card = document.createElement('a');
                    card.target = "_blank"; // Abrir em nova aba

                    if (item.type === 'store') {
                        card.href = `loja.html?userId=${item.id}`;
                        card.className = 'store-card';
                        card.innerHTML = `
                            <div class="card-banner" style="background-image: url('${item.logo || 'https://placehold.co/600x340/EADDFF/21005D?text=Loja'}')"></div>
                            <div class="card-content">
                                <h3 class="store-card__title">${item.name}</h3>
                                <p class="store-card__description">${item.description || 'Visite nossa loja para ver os produtos.'}</p>
                                <span class="store-card__button">Ver Loja →</span>
                            </div>
                        `;
                    } else { // type === 'product'
                        card.href = `loja.html?userId=${item.storeId}`;
                        card.className = 'product-card';
                        card.innerHTML = `
                            <div class="card-banner" style="background-image: url('${item.image || 'https://placehold.co/600x340/EADDFF/21005D?text=Produto'}')"></div>
                            <div class="card-content">
                                <span class="product-card__store-name">${item.storeName}</span>
                                <h3 class="product-card__title">${item.name}</h3>
                                <p class="product-card__price">R$ ${(item.price || 0).toFixed(2).replace('.',',')}</p>
                            </div>
                        `;
                    }
                    fragment.appendChild(card);
                });
                resultsGrid.appendChild(fragment);
            }

            function sortAndFilter() {
                const sortByName = (a, b) => {
                    const nameA = a.name || '';
                    const nameB = b.name || '';
                    if (sortOrder === 'asc') return nameA.localeCompare(nameB);
                    return nameB.localeCompare(nameA);
                };

                const query = searchInput.value.toLowerCase().trim();
                if (!query) {
                    const sortedStores = [...allStores].sort(sortByName);
                    renderResults(sortedStores.map(s => ({ type: 'store', ...s })));
                    return;
                }

                const foundItems = new Map();
                allStores.forEach(store => {
                    if (store.name && store.name.toLowerCase().includes(query)) {
                        foundItems.set(`store-${store.id}`, { type: 'store', ...store });
                    }
                    if (store.products) {
                        store.products.forEach(product => {
                             if (product.name && product.name.toLowerCase().includes(query)) {
                                foundItems.set(`product-${store.id}-${product.id}`, {
                                    type: 'product',
                                    ...product,
                                    storeId: store.id,
                                    storeName: store.name
                                });
                            }
                        });
                    }
                });
                
                const sortedItems = Array.from(foundItems.values()).sort(sortByName);
                renderResults(sortedItems);
            }

            function toggleSortOrder() {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                const icon = sortButton.querySelector('i');
                icon.textContent = sortOrder === 'asc' ? 'arrow_downward' : 'arrow_upward';
                icon.style.transform = sortOrder === 'asc' ? 'rotate(0deg)' : 'rotate(180deg)';
                sortAndFilter();
            }

            function showEmptyState(show, message = 'Nenhum resultado para sua busca') {
                if (show) {
                    resultsGrid.innerHTML = '';
                    emptyState.style.display = 'block';
                    emptyState.querySelector('h2').textContent = message;
                } else {
                    emptyState.style.display = 'none';
                }
            }
            
            searchInput.addEventListener('input', debounce(sortAndFilter, 300));
            sortButton.addEventListener('click', toggleSortOrder);

            showSkeletons();
            fetchStores();
        });
    </script>
</body>
</html>
